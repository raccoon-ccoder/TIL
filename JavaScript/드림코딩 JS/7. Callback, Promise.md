## 7. [ë“œë¦¼ì½”ë”© JS - 7. Callback, Promise]
ìžë°”ìŠ¤í¬ë¦½íŠ¸sms ë™ê¸°ì ì´ì–´ì„œ ì½”ë“œê°€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©° ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ `Callback`, `Promise`, `await/async`ê°€ ìžˆë‹¤.   
ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í•˜ëŠ” ê°„ë‹¨í•œ ì´ìœ ëŠ” ì›í•˜ëŠ” ë•Œì— ë™ìž‘ì´ ì‹œìž‘í•  ìˆ˜ ìžˆë„ë¡ í•˜ê¸° ìœ„í•¨ì´ ìžˆë‹¤.

### Callback
```js
console.log('1');
setTimeout(() => console.log('2'), 1000);
console.log('3');

// 1
// 3
// 2 (setTimeout() í˜¸ì¶œ í›„ 1ì´ˆ ë’¤ì—)
```
- ìœ„ ì½”ë“œì—ì„œ setTime() ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ì¸ consloe.log()ëŠ” ë°”ë¡œ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ 1ì´ˆ ë’¤ì•  ì‹¤í–‰í•˜ëŠ” ì½œë°±í•¨ìˆ˜ì´ë‹¤.

#### Synchronous callback
```js
// ì¦‰ê°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ì½œë°± í•¨ìˆ˜
function printImmediately(print) {
    print();
}

printImmediately(() => console.log('hello'));   // hello
```

#### Asynchronous callback
```js
// ì–¸ì œ ì‹¤í–‰ë˜ëŠ”ì§€ ì˜ˆì¸¡í•  ìˆ˜ ì—†ëŠ” ì½œë°± í•¨ìˆ˜
function printWithDelay(print, timeout) {
    setTimeout(print, timeout);
}

printWithDelay(() => console.log('async callback'), 2000);  // async callback (2ì´ˆ í›„ ì‹¤í–‰)
```
#### Callback Hell
```js
class UserStorage {
    loginUser(id, password, onSuccess, onError) {
        setTimeout(() => {
            if (
                (id === 'raccoon' && password === '123') ||
                (id === 'cat' && password === '456')
            ) {
                onSuccess(id);
            } else {
                onError(new Error('not found'));
            }
        }, 2000);
    }

    getRoles(user, onSuccess, onError) {
        setTimeout(() => {
            if (user === 'raccoon') {
                onSuccess({ name: 'raccoon', role: 'admin'});
            } else {
                onError(new Error('no access'));
            }
        }, 1000);
    }
}

const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage.loginUser(
    id,
    password,
    user => {
        userStorage.getRoles(
            user, 
            userWithRole => {
                alert(`hello, ${userWithRole.name}, you have a ${userWithRole.role} role`);
            },
            error => {
                console.log(error);
            }
        );
    },
    error => {
        console.log(error);
    }
);
```
- ì‚¬ìš©ìžì—ê²Œ id, passwordë¥¼ ìž…ë ¥ ë°›ì•„ ê°€ìž…ëœ ì‚¬ìš©ìžì¸ì§€, ê¶Œí•œì´ ìžˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì½”ë“œë¡œ setTimeout()ì„ ì´ìš©í•´ ì‹œê°„ì°¨ë¥¼ ë‘¬ì„œ ì„œë²„ì™€ í†µì‹ í•œë‹¤ê³  ê°€ì •í•œë‹¤.  
- ìœ„ ì½”ë“œì²˜ëŸ¼ ê¼¬ë¦¬ë¥¼ ë¬´ëŠ” ë¹„ë™ê¸° ë™ìž‘ì´ ë§Žì•„ì§€ë©´ ê°€ë…ì„±ì´ ë–¨ì–´ì§€ë©° ê¹Šì€ ì¤‘ì²© ì½”ë“œë¡œ ì¸í•œ `ì½œë°± ì§€ì˜¥ íŒ¨í„´`ì„ ë§žì´í•˜ê²Œ ëœë‹¤.

### Promise
```js
let promise = new Promise(function(resolve, reject) {
  // executor (ì œìž‘ ì½”ë“œ, 'ê°€ìˆ˜')
});
```
- ì½œë°± í•¨ìˆ˜ ëŒ€ì‹  ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ” ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ `JavaScript ê°ì²´`ë‹¤.
- new Promise ìƒì„±ìžê°€ ë°˜í™˜í•˜ëŠ” promise ê°ì²´ëŠ” `state`, `result` ë¼ëŠ” ë‚´ë¶€ í”„ë¡œí¼í‹°ë¥¼ ê°–ëŠ”ë‹¤.
- promiseì—ì„œ ì¤‘ìš”í•œ í¬ì¸íŠ¸ëŠ” state, producer & consuemr ì´ë‹¤.
- `state` - operationì„ ìˆ˜í–‰ ì¤‘ì¸ì§€, ìˆ˜í–‰ ì™„ë£Œ í–ˆëŠ”ì§€, ìˆ˜í–‰ ì‹¤íŒ¨í–ˆëŠ”ì§€ì— ëŒ€í•œ ìƒíƒœ
  - `pending` - promiseê°€ ë§Œë“¤ì–´ì ¸ì„œ ìš°ë¦¬ê°€ ì§€ì •í•œ operationì´ ìˆ˜í–‰ ì¤‘ì¼ ê²½ìš°
  - `fulfilled` - operationì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ëœ ê²½ìš°
  - `rejected` - operationì´ ì‹¤íŒ¨í•œ ê²½ìš°
- `result` - ì²˜ìŒì—” undefined, resolve(value)ê°€ í˜¸ì¶œë˜ë©´ `value`, reject(error)ê°€ í˜¸ì¶œë˜ë©´ `error`ë¡œ ë³€í•œë‹¤.
- `producer & consumer` - ê°„ë‹¨í•˜ê²Œ ë°ì´í„°ë¥¼ ì œê³µí•˜ëŠ” ì‚¬ëžŒ, ì œê³µëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ëžŒì˜ ì°¨ì´

#### Producer
- Promise ê°ì²´ë¥¼ ë§Œë“œëŠ” ìˆœê°„ ë‚´ë¶€ì˜ `executorâˆšë¼ëŠ” ì‹¤í–‰ í•¨ìˆ˜ê°€ ë°”ë¡œ ì‹¤í–‰ëœë‹¤.
- ë”°ë¼ì„œ ë²„íŠ¼ í´ë¦­ì‹œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì¼ì¸ ê²½ìš° promise ê°ì²´ë¥¼ ìƒì„±í•˜ë©´ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì´ ì´ë¤„ì§ˆ ìˆ˜ ìžˆë‹¤.
```js
const promise = new Promise((resolve, reject) => {
    // doing some heavy work (network, read files..)
    console.log('doing something...');
    setTimeout(() => {
        // resolve('raccoon');  // (operationì— ì„±ê³µí–ˆì„ ê²½ìš°) raccoon
        reject(new Error('no network'));    // (operationì— ì‹¤íŒ¨í–ˆì„ ê²½ìš°) Uncaught (in promise) Error: no network
    }, 2000);
});
```

#### Consumer
- Promise ê°ì²´ëŠ” executor ì‹¤í–‰ í•¨ìˆ˜ì™€ ê²°ê³¼ë‚˜ ì—ëŸ¬ë¥¼ ë°›ì„ ì†Œë¹„ í•¨ìˆ˜ë¥¼ ì´ì–´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.
- ì†Œë¹„ í•¨ìˆ˜ëŠ” `then()`, `catch()`, `finally()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•œë‹¤.
```js
promise
    .then((value) => {
        console.log(value); // raccoon
    })
    .catch(error => {
        console.log(error); // Error: no network
    })
    .finally(() => {    // ì„±ê³µ ì‹¤íŒ¨ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ë¬´ì¡°ê±´ ì‹¤í–‰í•˜ê³  ì‹¶ì„ ê²½ìš°
        console.log('finally'); // finally
    });
// then í˜¸ì¶œì‹œ Promise ê°ì²´ê°€ return ë˜ê¸°ì— ê·¸ ê°ì²´ì— catchë¥¼ ì ìš©í•¨ (ì²´ì´ë‹)
```

#### Consumer - then()
```js
promise.then(
  function(result) { /* ê²°ê³¼(result)ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤ */ },
  function(error) { /* ì—ëŸ¬(error)ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤ */ }
);
```
- ì²«ë²ˆì§¸ ì¸ìˆ˜ëŠ” promiseê°€ `ì´í–‰`ë˜ì—ˆì„ ë•Œ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ë¡œ ì—¬ê¸°ì„œ `ì‹¤í–‰ ê²°ê³¼`ë¥¼ ë°›ëŠ”ë‹¤.
- ë‘ë²ˆì§¸ ì¸ìˆ˜ëŠ” promiseê°€ `ê±°ë¶€`ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ê³ , ì—¬ê¸°ì„œ `ì—ëŸ¬`ë¥¼ ë°›ëŠ”ë‹¤.
- ìž‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ëœ ê²½ìš°ë§Œ ë‹¤ë£¨ê³  ì‹¶ë‹¤ë©´ then()ì— ì¸ìˆ˜ë¥¼ í•˜ë‚˜ë§Œ ì „ë‹¬í•œë‹¤.

### Promise chaining
- ë¹„ë™ê¸° ìž‘ì—…ì´ ì—¬ëŸ¬ ê°œ ìžˆì„ ê²½ìš° `Promise chaining`ì„ ì´ìš©í•  ìˆ˜ ìžˆë‹¤.
```js
const fetchNumber = new Promise((resolve, reject) => {
    setTimeout(() => resolve(1), 1000);
});

fetchNumber
    .then(num => num * 2)
    .then(num => num * 3)
    .then(num => {
        return new Promise((resolve, reject) => {
            setTimeout(() => resolve(num - 1), 1000);
        });
    })
    .then(num => console.log(num)); // 5
```
- promise chainingì´ ê°€ëŠ¥í•œ ì´ìœ ëŠ” fetchNumber ëŠ” promise ê°ì²´ê³  promise.then()ì„ í•˜ë©´ promiseê°€ ë°˜í™˜ë˜ê¸° ë•Œë¬¸ì´ë‹¤. ê±°ê¸°ì—ëŠ” ë‹¹ì—°ížˆ then()ì„ í˜¸ì¶œí•  ìˆ˜ ìžˆë‹¤.  
**Q) then()ì€ promiseì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ” ë©”ì„œë“œ ì•„ë‹Œê°€?**
â†’ í•¸ë“¤ëŸ¬ê°€ ê°’ì„ ë°˜í™˜í•˜ë©´ `result`ê°€ ë˜ê³  ë‹¤ìŒ then()ì€ ì´ ê°’ì„ ì´ìš©í•´ í˜¸ì¶œëœë‹¤. 

### Promise Error Handling
- promiseê°€ ê±°ë¶€ë˜ë©´ ì œì–´ íë¦„ì´ ì œì¼ ê°€ê¹Œìš´ rejection í•¸ë“¤ëŸ¬ë¡œ ë„˜ì–´ê°€ê¸°ì— `promise chaining`ì„ ì‚¬ìš©í•˜ì—¬ ì—ëŸ¬ë¥¼ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìžˆë‹¤.
- ì•„ëž˜ ì—ëŸ¬ ë°œìƒì‹œ ì½”ë“œì²˜ëŸ¼ `catch()`ëŠ” ì²«ë²ˆì§¸ í•¸ë“¤ëŸ¬ì¼ í•„ìš”ê°€ ì—†ìœ¼ë©° ì—¬ëŸ¬ ê°œì˜ `then()` ë’¤ì— ì˜¬ ìˆ˜ë„ ìžˆë‹¤.
```js
// ì •ìƒ ì½”ë“œ
const getHen = () =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve('ðŸ“'), 1000);
    });
const getEgg = hen =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${hen} => ðŸ¥š`), 1000);
    });
const cook = egg =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${egg} => ðŸ³`), 1000);
    });

getHen()
    .then(getEgg)   // ì½œë°±í•¨ìˆ˜ ì „ë‹¬ì‹œ ë°›ì•„ì˜¤ëŠ” valueë¥¼ ë‹¤ë¥¸ í•¨ìˆ˜ì— ë°”ë¡œ ë„£ì–´ì£¼ëŠ” ê²½ìš° value ìƒëžµ ê°€ëŠ¥
    .then(egg => cook(egg))
    .then(meal => console.log(meal))   // ðŸ“ => ðŸ¥š => ðŸ³
    .catch(console.log);
```
```js
// ì—ëŸ¬ê°€ ìƒê²¼ì„ ê²½ìš°
const getHen = () =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve('ðŸ“'), 1000);
    });
const getEgg = hen =>
    new Promise((resolve, reject) => {
        setTimeout(() => reject(new Error(`${hen} => ðŸ¥š`)), 1000);   // ì—ëŸ¬ ë°œìƒ !!! 
    });
const cook = egg =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${egg} => ðŸ³`), 1000);
    });

getHen()
    .then(getEgg)   // ì½œë°±í•¨ìˆ˜ ì „ë‹¬ì‹œ ë°›ì•„ì˜¤ëŠ” valueë¥¼ ë‹¤ë¥¸ í•¨ìˆ˜ì— ë°”ë¡œ ë„£ì–´ì£¼ëŠ” ê²½ìš° value ìƒëžµ ê°€ëŠ¥
    .catch(error => {   // ê³„ëž€ì„ ë°›ì•„ì˜¤ëŠ” ê²ƒì— ë¬¸ì œê°€ ìƒê¸¸ ê²½ìš° ë¹µìœ¼ë¡œ ëŒ€ì²´í•˜ëŠ” ì½”ë“œ
        return 'ðŸž';
    })
    .then(egg => cook(egg))
    .then(meal => console.log(meal))   // ðŸž => ðŸ³
    .catch(console.log);
```

#### ë§Œì•½ catch()ê°€ ì—†ë‹¤ë©´ ?
```js
new Promise(function() {
  noSuchFunction(); // ì—ëŸ¬ (ì¡´ìž¬í•˜ì§€ ì•ŠëŠ” í•¨ìˆ˜)
})
  .then(() => {
    // ì„±ê³µìƒíƒœì˜ í”„ë¼ë¯¸ìŠ¤ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬. í•œ ê°œ í˜¹ì€ ì—¬ëŸ¬ ê°œê°€ ìžˆì„ ìˆ˜ ìžˆìŒ
  }); // ëì— .catchê°€ ì—†ìŒ!
```
- ì—ëŸ¬ ë°œìƒì‹œ promiseëŠ” ê±°ë¶€ ìƒíƒœê°€ ë˜ê³ , ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•´ì¤„ í•¸ë“¤ëŸ¬ê°€ ì—†ê¸°ì— ì—ëŸ¬ê°€ 'ê°‡í˜€ë²„ë¦°ë‹¤'.
- ìžë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì€ promise ê±°ë¶€ë¥¼ ì¶”ì í•˜ë‹¤ ìœ„ì™€ ê°™ì€ ìƒí™© ë°œìƒì‹œ, ì „ì—­ ì—ëŸ¬ë¥¼ ìƒì„±í•˜ë©° ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„  `unhandledrejection` ì´ë²¤íŠ¸ë¡œ ìž¡ì„ ìˆ˜ ìžˆë‹¤.
```js
window.addEventListener('unhandledrejection', function(event) {
  // ì´ë²¤íŠ¸ì—” ë‘ ê°œì˜ íŠ¹ë³„ í”„ë¡œí¼í‹°ê°€ ìžˆìŠµë‹ˆë‹¤.
  alert(event.promise); // [object Promise] - ì—ëŸ¬ë¥¼ ìƒì„±í•˜ëŠ” í”„ë¼ë¯¸ìŠ¤
  alert(event.reason); // Error: ì—ëŸ¬ ë°œìƒ! - ì²˜ë¦¬í•˜ì§€ ëª»í•œ ì—ëŸ¬ ê°ì²´
});

new Promise(function() {
  throw new Error("ì—ëŸ¬ ë°œìƒ!");
}); // ì—ëŸ¬ ì²˜ë¦¬ í•¸ë“¤ëŸ¬, catchê°€ ì—†ìŒ
```
- `unhandledrejection` í•¸ë“¤ëŸ¬ëŠ” ì—ëŸ¬ ì •ë³´ê°€ ë‹´ê¸´ `event` ê°ì²´ë¥¼ ë°›ê¸°ì— ì´ í•¸ë“¤ëŸ¬ ì•ˆì—ì„œ ì›í•˜ëŠ” ìž‘ì—…ì„ í•  ìˆ˜ ìžˆë‹¤.
- ëŒ€ê°œ ì´ëŸ° ì—ëŸ¬ëŠ” íšŒë³µí•  ìˆ˜ ì—†ê¸°ì— ê°œë°œìžë¡œì„œ í•  ìˆ˜ ìžˆëŠ” ìµœì„ ì˜ ë°©ë²•ì€ ì‚¬ìš©ìžì—ê²Œ ë¬¸ì œ ìƒí™©ì„ ì•Œë¦¬ê³  ê°€ëŠ¥í•˜ë©´ ì„œë²„ì— ì—ëŸ¬ ì •ë³´ë¥¼ ë³´ë‚´ëŠ” ê²ƒì´ë‹¤.
    
### Callback hell to Promise
```js
'use strict';
class UserStorage {
    loginUser(id, password) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (
                    (id === 'raccoon' && password === '123') ||
                    (id === 'cat' && password === '456')
                ) {
                    resolve(id);
                } else {
                    reject(new Error('not found'));
                }
            })
        }, 2000);
    }

    getRoles(user) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (user === 'raccoon') {
                    resolve({ name: 'raccoon', role: 'admin'});
                } else {
                    reject(new Error('no access'));
                }
            }, 2000);
        })
    }
}

const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage
    .loginUser(id, password)
    .then(userStorage.getRoles)
    .then(console.log)
    .catch(console.log);
```

