## 7. [ë“œë¦¼ì½”ë”© JS - 7. Callback, Promise, async & await]
ìë°”ìŠ¤í¬ë¦½íŠ¸sms ë™ê¸°ì ì´ì–´ì„œ ì½”ë“œê°€ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©° ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ `Callback`, `Promise`, `await/async`ê°€ ìˆë‹¤.   
ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í•˜ëŠ” ê°„ë‹¨í•œ ì´ìœ ëŠ” ì›í•˜ëŠ” ë•Œì— ë™ì‘ì´ ì‹œì‘í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•¨ì´ ìˆë‹¤.

### Callback
```js
console.log('1');
setTimeout(() => console.log('2'), 1000);
console.log('3');

// 1
// 3
// 2 (setTimeout() í˜¸ì¶œ í›„ 1ì´ˆ ë’¤ì—)
```
- ìœ„ ì½”ë“œì—ì„œ setTime() ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ì¸ consloe.log()ëŠ” ë°”ë¡œ ì‹¤í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ 1ì´ˆ ë’¤ì•  ì‹¤í–‰í•˜ëŠ” ì½œë°±í•¨ìˆ˜ì´ë‹¤.

#### Synchronous callback
```js
// ì¦‰ê°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ì½œë°± í•¨ìˆ˜
function printImmediately(print) {
    print();
}

printImmediately(() => console.log('hello'));   // hello
```

#### Asynchronous callback
```js
// ì–¸ì œ ì‹¤í–‰ë˜ëŠ”ì§€ ì˜ˆì¸¡í•  ìˆ˜ ì—†ëŠ” ì½œë°± í•¨ìˆ˜
function printWithDelay(print, timeout) {
    setTimeout(print, timeout);
}

printWithDelay(() => console.log('async callback'), 2000);  // async callback (2ì´ˆ í›„ ì‹¤í–‰)
```
#### Callback Hell
```js
class UserStorage {
    loginUser(id, password, onSuccess, onError) {
        setTimeout(() => {
            if (
                (id === 'raccoon' && password === '123') ||
                (id === 'cat' && password === '456')
            ) {
                onSuccess(id);
            } else {
                onError(new Error('not found'));
            }
        }, 2000);
    }

    getRoles(user, onSuccess, onError) {
        setTimeout(() => {
            if (user === 'raccoon') {
                onSuccess({ name: 'raccoon', role: 'admin'});
            } else {
                onError(new Error('no access'));
            }
        }, 1000);
    }
}

const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage.loginUser(
    id,
    password,
    user => {
        userStorage.getRoles(
            user, 
            userWithRole => {
                alert(`hello, ${userWithRole.name}, you have a ${userWithRole.role} role`);
            },
            error => {
                console.log(error);
            }
        );
    },
    error => {
        console.log(error);
    }
);
```
- ì‚¬ìš©ìì—ê²Œ id, passwordë¥¼ ì…ë ¥ ë°›ì•„ ê°€ì…ëœ ì‚¬ìš©ìì¸ì§€, ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì½”ë“œë¡œ setTimeout()ì„ ì´ìš©í•´ ì‹œê°„ì°¨ë¥¼ ë‘¬ì„œ ì„œë²„ì™€ í†µì‹ í•œë‹¤ê³  ê°€ì •í•œë‹¤.  
- ìœ„ ì½”ë“œì²˜ëŸ¼ ê¼¬ë¦¬ë¥¼ ë¬´ëŠ” ë¹„ë™ê¸° ë™ì‘ì´ ë§ì•„ì§€ë©´ ê°€ë…ì„±ì´ ë–¨ì–´ì§€ë©° ê¹Šì€ ì¤‘ì²© ì½”ë“œë¡œ ì¸í•œ `ì½œë°± ì§€ì˜¥ íŒ¨í„´`ì„ ë§ì´í•˜ê²Œ ëœë‹¤.

***  

### Promise
```js
let promise = new Promise(function(resolve, reject) {
  // executor (ì œì‘ ì½”ë“œ, 'ê°€ìˆ˜')
});
```
- ì½œë°± í•¨ìˆ˜ ëŒ€ì‹  ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•œ `JavaScript ê°ì²´`ë‹¤.
- new Promise ìƒì„±ìê°€ ë°˜í™˜í•˜ëŠ” promise ê°ì²´ëŠ” `state`, `result` ë¼ëŠ” ë‚´ë¶€ í”„ë¡œí¼í‹°ë¥¼ ê°–ëŠ”ë‹¤.
- `state`, `result` ë‚´ë¶€ í”„ë¡œí¼í‹°ëŠ” ê°œë°œìê°€ ì§ì ‘ ì ‘ê·¼í•  ìˆ˜ ì—†ìœ¼ë©°  `.then`/ `.catch`/ `.finally` ë©”ì„œë“œë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤.
- promiseì—ì„œ ì¤‘ìš”í•œ í¬ì¸íŠ¸ëŠ” state, producer & consuemr ì´ë‹¤.
- `state` - operationì„ ìˆ˜í–‰ ì¤‘ì¸ì§€, ìˆ˜í–‰ ì™„ë£Œ í–ˆëŠ”ì§€, ìˆ˜í–‰ ì‹¤íŒ¨í–ˆëŠ”ì§€ì— ëŒ€í•œ ìƒíƒœ
  - `pending` - promiseê°€ ë§Œë“¤ì–´ì ¸ì„œ ìš°ë¦¬ê°€ ì§€ì •í•œ operationì´ ìˆ˜í–‰ ì¤‘ì¼ ê²½ìš°
  - `fulfilled` - operationì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰ëœ ê²½ìš°
  - `rejected` - operationì´ ì‹¤íŒ¨í•œ ê²½ìš°
- `result` - ì²˜ìŒì—” undefined, resolve(value)ê°€ í˜¸ì¶œë˜ë©´ `value`, reject(error)ê°€ í˜¸ì¶œë˜ë©´ `error`ë¡œ ë³€í•œë‹¤.
- `producer & consumer` - ê°„ë‹¨í•˜ê²Œ ë°ì´í„°ë¥¼ ì œê³µí•˜ëŠ” ì‚¬ëŒ, ì œê³µëœ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ëŒì˜ ì°¨ì´

#### Producer
- Promise ê°ì²´ë¥¼ ë§Œë“œëŠ” ìˆœê°„ ë‚´ë¶€ì˜ `executor`ë¼ëŠ”  í•¨ìˆ˜ê°€ ë°”ë¡œ ì‹¤í–‰ëœë‹¤.
- ë”°ë¼ì„œ ë²„íŠ¼ í´ë¦­ì‹œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ” ì¼ì¸ ê²½ìš° promise ê°ì²´ë¥¼ ìƒì„±í•˜ë©´ ë¶ˆí•„ìš”í•œ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì´ ì´ë¤„ì§ˆ ìˆ˜ ìˆë‹¤.
```js
const promise = new Promise((resolve, reject) => {
    // doing some heavy work (network, read files..)
    console.log('doing something...');
    setTimeout(() => {
        // resolve('raccoon');  // (operationì— ì„±ê³µí–ˆì„ ê²½ìš°) raccoon
        reject(new Error('no network'));    // (operationì— ì‹¤íŒ¨í–ˆì„ ê²½ìš°) Uncaught (in promise) Error: no network
    }, 2000);
});
```

#### Consumer
- Promise ê°ì²´ëŠ” executor ì‹¤í–‰ í•¨ìˆ˜ì™€ ê²°ê³¼ë‚˜ ì—ëŸ¬ë¥¼ ë°›ì„ ì†Œë¹„ í•¨ìˆ˜ë¥¼ ì´ì–´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.
- ì†Œë¹„ í•¨ìˆ˜ëŠ” `then()`, `catch()`, `finally()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•œë‹¤.
```js
promise
    .then((value) => {
        console.log(value); // raccoon
    })
    .catch(error => {
        console.log(error); // Error: no network
    })
    .finally(() => {    // ì„±ê³µ ì‹¤íŒ¨ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ë¬´ì¡°ê±´ ì‹¤í–‰í•˜ê³  ì‹¶ì„ ê²½ìš°
        console.log('finally'); // finally
    });
// then í˜¸ì¶œì‹œ Promise ê°ì²´ê°€ return ë˜ê¸°ì— ê·¸ ê°ì²´ì— catchë¥¼ ì ìš©í•¨ (ì²´ì´ë‹)
```

#### Consumer - then()
```js
promise.then(
  function(result) { /* ê²°ê³¼(result)ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤ */ },
  function(error) { /* ì—ëŸ¬(error)ë¥¼ ë‹¤ë£¹ë‹ˆë‹¤ */ }
);
```
- ì²«ë²ˆì§¸ ì¸ìˆ˜ëŠ” promiseê°€ `ì´í–‰`ë˜ì—ˆì„ ë•Œ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜ë¡œ ì—¬ê¸°ì„œ `ì‹¤í–‰ ê²°ê³¼`ë¥¼ ë°›ëŠ”ë‹¤.
- ë‘ë²ˆì§¸ ì¸ìˆ˜ëŠ” promiseê°€ `ê±°ë¶€`ë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ê³ , ì—¬ê¸°ì„œ `ì—ëŸ¬`ë¥¼ ë°›ëŠ”ë‹¤.
- ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ëœ ê²½ìš°ë§Œ ë‹¤ë£¨ê³  ì‹¶ë‹¤ë©´ then()ì— ì¸ìˆ˜ë¥¼ í•˜ë‚˜ë§Œ ì „ë‹¬í•œë‹¤.

### Promise chaining
- ë¹„ë™ê¸° ì‘ì—…ì´ ì—¬ëŸ¬ ê°œ ìˆì„ ê²½ìš° `Promise chaining`ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤.
```js
const fetchNumber = new Promise((resolve, reject) => {
    setTimeout(() => resolve(1), 1000);
});

fetchNumber
    .then(num => num * 2)
    .then(num => num * 3)
    .then(num => {
        return new Promise((resolve, reject) => {
            setTimeout(() => resolve(num - 1), 1000);
        });
    })
    .then(num => console.log(num)); // 5
```
- promise chainingì´ ê°€ëŠ¥í•œ ì´ìœ ëŠ” fetchNumber ëŠ” promise ê°ì²´ê³  promise.then()ì„ í•˜ë©´ promiseê°€ ë°˜í™˜ë˜ê¸° ë•Œë¬¸ì´ë‹¤. ê±°ê¸°ì—ëŠ” ë‹¹ì—°íˆ then()ì„ í˜¸ì¶œí•  ìˆ˜ ìˆë‹¤.  
**Q) then()ì€ promiseì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œ ì•„ë‹Œê°€?**    
â†’ í•¸ë“¤ëŸ¬ê°€ ê°’ì„ ë°˜í™˜í•˜ë©´ `result`ê°€ ë˜ê³  ë‹¤ìŒ then()ì€ ì´ ê°’ì„ ì´ìš©í•´ í˜¸ì¶œëœë‹¤. 

### Promise Error Handling
- promiseê°€ ê±°ë¶€ë˜ë©´ ì œì–´ íë¦„ì´ ì œì¼ ê°€ê¹Œìš´ rejection í•¸ë“¤ëŸ¬ë¡œ ë„˜ì–´ê°€ê¸°ì— `promise chaining`ì„ ì‚¬ìš©í•˜ì—¬ ì—ëŸ¬ë¥¼ ì‰½ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
- ì•„ë˜ ì—ëŸ¬ ë°œìƒì‹œ ì½”ë“œì²˜ëŸ¼ `catch()`ëŠ” ì²«ë²ˆì§¸ í•¸ë“¤ëŸ¬ì¼ í•„ìš”ê°€ ì—†ìœ¼ë©° ì—¬ëŸ¬ ê°œì˜ `then()` ë’¤ì— ì˜¬ ìˆ˜ë„ ìˆë‹¤.
```js
// ì •ìƒ ì½”ë“œ
const getHen = () =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve('ğŸ“'), 1000);
    });
const getEgg = hen =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${hen} => ğŸ¥š`), 1000);
    });
const cook = egg =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${egg} => ğŸ³`), 1000);
    });

getHen()
    .then(getEgg)   // ì½œë°±í•¨ìˆ˜ ì „ë‹¬ì‹œ ë°›ì•„ì˜¤ëŠ” valueë¥¼ ë‹¤ë¥¸ í•¨ìˆ˜ì— ë°”ë¡œ ë„£ì–´ì£¼ëŠ” ê²½ìš° value ìƒëµ ê°€ëŠ¥
    .then(egg => cook(egg))
    .then(meal => console.log(meal))   // ğŸ“ => ğŸ¥š => ğŸ³
    .catch(console.log);
```
```js
// ì—ëŸ¬ê°€ ìƒê²¼ì„ ê²½ìš°
const getHen = () =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve('ğŸ“'), 1000);
    });
const getEgg = hen =>
    new Promise((resolve, reject) => {
        setTimeout(() => reject(new Error(`${hen} => ğŸ¥š`)), 1000);   // ì—ëŸ¬ ë°œìƒ !!! 
    });
const cook = egg =>
    new Promise((resolve, reject) => {
        setTimeout(() => resolve(`${egg} => ğŸ³`), 1000);
    });

getHen()
    .then(getEgg)   // ì½œë°±í•¨ìˆ˜ ì „ë‹¬ì‹œ ë°›ì•„ì˜¤ëŠ” valueë¥¼ ë‹¤ë¥¸ í•¨ìˆ˜ì— ë°”ë¡œ ë„£ì–´ì£¼ëŠ” ê²½ìš° value ìƒëµ ê°€ëŠ¥
    .catch(error => {   // ê³„ë€ì„ ë°›ì•„ì˜¤ëŠ” ê²ƒì— ë¬¸ì œê°€ ìƒê¸¸ ê²½ìš° ë¹µìœ¼ë¡œ ëŒ€ì²´í•˜ëŠ” ì½”ë“œ
        return 'ğŸ';
    })
    .then(egg => cook(egg))
    .then(meal => console.log(meal))   // ğŸ => ğŸ³
    .catch(console.log);
```

#### ë§Œì•½ catch()ê°€ ì—†ë‹¤ë©´ ?
```js
new Promise(function() {
  noSuchFunction(); // ì—ëŸ¬ (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í•¨ìˆ˜)
})
  .then(() => {
    // ì„±ê³µìƒíƒœì˜ í”„ë¼ë¯¸ìŠ¤ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¸ë“¤ëŸ¬. í•œ ê°œ í˜¹ì€ ì—¬ëŸ¬ ê°œê°€ ìˆì„ ìˆ˜ ìˆìŒ
  }); // ëì— .catchê°€ ì—†ìŒ!
```
- ì—ëŸ¬ ë°œìƒì‹œ promiseëŠ” ê±°ë¶€ ìƒíƒœê°€ ë˜ê³ , ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•´ì¤„ í•¸ë“¤ëŸ¬ê°€ ì—†ê¸°ì— ì—ëŸ¬ê°€ 'ê°‡í˜€ë²„ë¦°ë‹¤'.
- ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì€ promise ê±°ë¶€ë¥¼ ì¶”ì í•˜ë‹¤ ìœ„ì™€ ê°™ì€ ìƒí™© ë°œìƒì‹œ, ì „ì—­ ì—ëŸ¬ë¥¼ ìƒì„±í•˜ë©° ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„  `unhandledrejection` ì´ë²¤íŠ¸ë¡œ ì¡ì„ ìˆ˜ ìˆë‹¤.
```js
window.addEventListener('unhandledrejection', function(event) {
  // ì´ë²¤íŠ¸ì—” ë‘ ê°œì˜ íŠ¹ë³„ í”„ë¡œí¼í‹°ê°€ ìˆìŠµë‹ˆë‹¤.
  alert(event.promise); // [object Promise] - ì—ëŸ¬ë¥¼ ìƒì„±í•˜ëŠ” í”„ë¼ë¯¸ìŠ¤
  alert(event.reason); // Error: ì—ëŸ¬ ë°œìƒ! - ì²˜ë¦¬í•˜ì§€ ëª»í•œ ì—ëŸ¬ ê°ì²´
});

new Promise(function() {
  throw new Error("ì—ëŸ¬ ë°œìƒ!");
}); // ì—ëŸ¬ ì²˜ë¦¬ í•¸ë“¤ëŸ¬, catchê°€ ì—†ìŒ
```
- `unhandledrejection` í•¸ë“¤ëŸ¬ëŠ” ì—ëŸ¬ ì •ë³´ê°€ ë‹´ê¸´ `event` ê°ì²´ë¥¼ ë°›ê¸°ì— ì´ í•¸ë“¤ëŸ¬ ì•ˆì—ì„œ ì›í•˜ëŠ” ì‘ì—…ì„ í•  ìˆ˜ ìˆë‹¤.
- ëŒ€ê°œ ì´ëŸ° ì—ëŸ¬ëŠ” íšŒë³µí•  ìˆ˜ ì—†ê¸°ì— ê°œë°œìë¡œì„œ í•  ìˆ˜ ìˆëŠ” ìµœì„ ì˜ ë°©ë²•ì€ ì‚¬ìš©ìì—ê²Œ ë¬¸ì œ ìƒí™©ì„ ì•Œë¦¬ê³  ê°€ëŠ¥í•˜ë©´ ì„œë²„ì— ì—ëŸ¬ ì •ë³´ë¥¼ ë³´ë‚´ëŠ” ê²ƒì´ë‹¤.
    
### Callback hell to Promise ì •ë‹µ ì½”ë“œ 
<details markdown="1">  
<summary>í•´ë‹µ</summary>   

```js
'use strict';
class UserStorage {
    loginUser(id, password) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (
                    (id === 'raccoon' && password === '123') ||
                    (id === 'cat' && password === '456')
                ) {
                    resolve(id);
                } else {
                    reject(new Error('not found'));
                }
            })
        }, 2000);
    }

    getRoles(user) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (user === 'raccoon') {
                    resolve({ name: 'raccoon', role: 'admin'});
                } else {
                    reject(new Error('no access'));
                }
            }, 2000);
        })
    }
}

const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage
    .loginUser(id, password)
    .then(userStorage.getRoles)
    .then(console.log)
    .catch(console.log);
```

</details>   

***  

### Promise API
### Promise.all()
- ì—¬ëŸ¬ ê°œì˜ promiseë¥¼ `ë™ì‹œì— ì‹¤í–‰`ì‹œí‚¤ê³  ëª¨ë“  promiseê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦° í›„ ìƒˆë¡œìš´ promiseë¥¼ ë°˜í™˜í•œë‹¤.
- ë³µìˆ˜ì˜ URLì— ë™ì‹œì— ìš”ì²­ì„ ë³´ë‚´ê³ , ë‹¤ìš´ë¡œë“œê°€ ëª¨ë‘ ì™„ë£Œëœ í›„ ì½˜í…ì¸ ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê²½ìš° Promise.allì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
- `Promise.all`ì— ì „ë‹¬ë˜ëŠ” promise ì¤‘ í•˜ë‚˜ë¼ë„ ê±°ë¶€ë˜ë©´, Promise.allì´ ë°˜í™˜í•˜ëŠ” promiseëŠ” ì—ëŸ¬ì™€ í•¨ê»˜ ê±°ë¶€ëœë‹¤.
```js
Promise.all([
  new Promise(resolve => setTimeout(() => resolve(1), 3000)), // 1
  new Promise(resolve => setTimeout(() => resolve(2), 2000)), // 2
  new Promise(resolve => setTimeout(() => resolve(3), 1000))  // 3
]).then(alert); // í”„ë¼ë¯¸ìŠ¤ ì „ì²´ê°€ ì²˜ë¦¬ë˜ë©´ 1, 2, 3ì´ ë°˜í™˜ë©ë‹ˆë‹¤. ê° í”„ë¼ë¯¸ìŠ¤ëŠ” ë°°ì—´ì„ êµ¬ì„±í•˜ëŠ” ìš”ì†Œê°€ ë©ë‹ˆë‹¤.
```
- ë°°ì—´ ì•ˆ promiseê°€ ì²˜ë¦¬ë˜ë©´ promiseë“¤ì˜ ê²°ê³¼ê°’ì„ ë‹´ì€ ë°°ì—´ì´ ìƒˆë¡œìš´ promiseì˜ `result`ê°€ ë˜ë©° ìœ„ ì½”ë“œì˜ resultëŠ” ë°°ì—´ `[1, 2, 3]`ì´ ëœë‹¤.
- ì°¸ê³ ë¡œ `Promise.all`ì˜ ì²« ë²ˆì§¸ promiseëŠ” ê°€ì¥ ëŠ¦ê²Œ ì´í–‰ë˜ë”ë¼ê³  ì²˜ë¦¬ ê²°ê³¼ëŠ” ë°°ì—´ì˜ ì²« ë²ˆì§¸ ìš”ì†Œì— ì €ì¥ëœë‹¤.

### Promise.race()
- `ê°€ì¥ ë¨¼ì € ì²˜ë¦¬`ë˜ëŠ” promiseì˜ ê²°ê³¼(í˜¹ì€ ì—ëŸ¬)ë¥¼ ë°˜í™˜í•œë‹¤.
```js
Promise.race([
  new Promise((resolve, reject) => setTimeout(() => resolve(1), 1000)),
  new Promise((resolve, reject) => setTimeout(() => reject(new Error("ì—ëŸ¬ ë°œìƒ!")), 2000)),
  new Promise((resolve, reject) => setTimeout(() => resolve(3), 3000))
]).then(alert); // 1
```
- ì²« ë²ˆì§¸ promiseê°€ ê°€ì¥ ë¹¨ë¦¬ ì²˜ë¦¬ìƒíƒœê°€ ë˜ê¸°ì— `1`ì´ `result` ê°’ì´ ëœë‹¤.
- `Promise.race`ë¥¼ ì‚¬ìš©í•˜ë©´ 'ê²½ì£¼(race)ì˜ ìŠ¹ì'ê°€ ë‚˜íƒ€ë‚œ ìˆœê°„ ë‹¤ë¥¸ promiseì˜ ê²°ê³¼ ë˜ëŠ” ì—ëŸ¬ëŠ” ë¬´ì‹œëœë‹¤.

***  

### async & await
- ES8ì—ì„œëŠ” promiseë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ëŠ” async & awaitê°€ ë„ì…ë˜ì—ˆë‹¤.

### async
- function ì•ì— ìœ„ì¹˜í•˜ë©° `asyn`c í‚¤ì›Œë“œ ì‚¬ìš©ì‹œ í•´ë‹¹ í•¨ìˆ˜ëŠ” í•­ìƒ `promise`ë¥¼ ë°˜í™˜í•˜ê³  promiseê°€ ì•„ë‹Œ ê°’ì„ ë°˜í™˜í•´ë„ fulfilledëœ promiseê°€ ë°˜í™˜ë˜ë„ë¡ í•œë‹¤.
```js
async function fetchUser() {
    // do network request in 10 secs...
    return 'raccoon';
}

const user = fetchUser();
user.then(console.log); // raccoon

console.log(user); 
// Promise {<fulfilled>: 'raccoon'}
// [[Prototype]]: Promise
// [[PromiseState]]: "fulfilled"
// [[PromiseResult]]: "raccoon"
```

### await
- `async` í•¨ìˆ˜ ì•ˆì—ì„œë§Œ ë™ì‘í•˜ì—¬ JavaScriptëŠ” `await` í‚¤ì›Œë“œë¥¼ ë§Œë‚˜ë©´ promiseê°€ ì²˜ë¦¬(settled)ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ê²°ê³¼ëŠ” ê·¸ ì´í›„ ë°˜í™˜ëœë‹¤.
- promiseê°€ ì²˜ë¦¬ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ì—”ì§„ì´ ë‹¤ë¥¸ ì¼(ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰, ì´ë²¤íŠ¸ ì²˜ë¦¬ ë“±)ì„ í•  ìˆ˜ ìˆê¸°ì—. CPU ë¦¬ì†ŒìŠ¤ê°€ ë‚­ë¹„ë˜ì§€ ì•ŠëŠ”ë‹¤.
- ì¦‰, `promise.then`ë³´ë‹¤ ë” ì„¸ë ¨ë˜ê²Œ promiseì˜ `result` ê°’ì„ ì–»ì„ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë¬¸ë²•ì´ë‹¤.
```js
async function f() {

  let promise = new Promise((resolve, reject) => {
    setTimeout(() => resolve("ì™„ë£Œ!"), 1000)
  });

  let result = await promise; // í”„ë¼ë¯¸ìŠ¤ê°€ ì´í–‰ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼ (*)

  alert(result); // "ì™„ë£Œ!"
}

f();
```
- ìœ„ ì½”ë“œì—ì„œ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ë„ì¤‘ì— `(*)`ë¡œ í‘œì‹œí•œ ì¤„ì—ì„œ ì‹¤í–‰ì´ ì¤‘ë‹¨ë˜ì—ˆë‹¤ê°€ promiseê°€ ì²˜ë¦¬ë˜ë©´ ì‹¤í–‰ì´ ì¬ê°œëœë‹¤.
- ì´ë•Œ promise ê°ì²´ì˜ result ê°’ì´ ë³€ìˆ˜ resultì— í• ë‹¹ë˜ë©° ìœ„ ì˜ˆì‹œë¥¼ ì‹¤í–‰í•˜ë©´ 1ì´ˆ ë’¤ì— 'ì™„ë£Œ!'ê°€ ì¶œë ¥ëœë‹¤.

- ë˜í•œ ìµœìƒìœ„ ë ˆë²¨ ì½”ë“œ(top-level code)ì—ì„  `await`ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. ì´ëŸ´ ë–ˆ ìµëª… async í•¨ìˆ˜ë¡œ ì½”ë“œë¥¼ ê°ì‹¸ë©´ ìµœìƒìœ„ ë ˆë²¨ ì½”ë“œì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
```js
// ìµœìƒìœ„ ë ˆë²¨ ì½”ë“œì—ì„  ë¬¸ë²• ì—ëŸ¬ê°€ ë°œìƒí•¨
let response = await fetch('/article/promise-chaining/user.json');
let user = await response.json();

// ìµœìƒìœ„ ë ˆë²¨ ì½”ë“œì—ì„œ await ì‚¬ìš© ê°€ëŠ¥í•¨
(async () => {
  let response = await fetch('/article/promise-chaining/user.json');
  let user = await response.json();
  ...
})();
```

#### async & await ì˜ˆì œ 1
```js
function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function getApple() {
    await delay(1000);
    return 'ğŸ';
}

async function getBanana() {
    await delay(1000);
    return 'ğŸŒ';
}

async function pickFruits() {
   const apple = await getApple();
   const banana  = await getBanana();
   return `${apple} + ${banana}`;
}

pickFruits().then(console.log); // ğŸ + ğŸŒ
```
- ì‚¬ê³¼ë¥¼ ë°›ì•„ì˜¤ê³  ë°”ë‚˜ë‚˜ë¥¼ ë°›ì•„ì™€ì„œ ëª¨ë“  ê³¼ì¼ì„ í˜¸ì¶œí•˜ëŠ” ì˜ˆì œ
- ì´ëŸ° ìƒí™©ì—ì„œ ë§Œì•½ getAppleì´ ì‹¤í–‰ë˜ëŠ” ë™ì•ˆ getBanana()ê°€ ê¸°ë‹¤ë¦´ í•„ìš”ê°€ ì—†ë‹¤ë©´ (ë‘ê°œì˜ í•¨ìˆ˜ê°€ ì—°ê´€ ê´€ê³„ê°€ ì—†ë‹¤ë©´) `Promise.all()`ì„ ì“°ëŠ” ê²ƒì´ ì¢‹ë‹¤.


#### async & await ì˜ˆì œ 2
- asyncê°€ ì•„ë‹Œ í•¨ìˆ˜ì—ì„œ async í•¨ìˆ˜ í˜¸ì¶œí•˜ê¸° í€´ì¦ˆ
- â€˜ì¼ë°˜â€™ í•¨ìˆ˜ê°€ í•˜ë‚˜ ìˆëŠ”ë°, ì—¬ê¸°ì„œ async í•¨ìˆ˜ë¥¼ ì–´ë–»ê²Œ í•˜ë©´ í˜¸ì¶œí•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œ?
```js
async function wait() {
  await new Promise(resolve => setTimeout(resolve, 1000));

  return 10;
}

function f() {
  // ...ì½”ë“œ...
  // async wait()ë¥¼ í˜¸ì¶œí•˜ê³  ê·¸ ê²°ê³¼ì¸ 10ì„ ì–»ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?
  // fëŠ” ì¼ë°˜ í•¨ìˆ˜ì´ê¸° ë•Œë¬¸ì— ì—¬ê¸°ì„  'await'ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤ëŠ” ì ì— ì£¼ì˜í•˜ì„¸ìš”!
}
```

<details markdown="1">  
<summary>í•´ë‹µ</summary>   

```js
async function wait() {
  await new Promise(resolve => setTimeout(resolve, 1000));

  return 10;
}

function f() {
  // shows 10 after 1 second
  wait().then(result => alert(result));
}

f();
```
- `async` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©´ promiseê°€ ë°˜í™˜ë˜ë¯€ë¡œ `.then`ì„ ë¶™ì´ë©´ ëœë‹¤.

</details>   

### async & await ì—ëŸ¬ í•¸ë“¤ë§
- `try & catch`ë¬¸ì´ë‚˜ asyncí•¨ìˆ˜ì— `.catch`ë¥¼ ì¶”ê°€í•´ ê±°ë¶€ëœ promiseë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
 ```js
 // 1. try & catch
async function f() {

  try {
    let response = await fetch('http://ìœ íš¨í•˜ì§€-ì•Šì€-url');
    let user = await response.json();
  } catch(err) {
    // fetchì™€ response.jsonì—ì„œ ë°œí–‰í•œ ì—ëŸ¬ ëª¨ë‘ë¥¼ ì—¬ê¸°ì„œ ì¡ìŠµë‹ˆë‹¤.
    alert(err);
  }
}

f();

// 2. .catch
async function f() {
  let response = await fetch('http://ìœ íš¨í•˜ì§€-ì•Šì€-url');
}

// f()ëŠ” ê±°ë¶€ ìƒíƒœì˜ í”„ë¼ë¯¸ìŠ¤ê°€ ë©ë‹ˆë‹¤.
f().catch(alert); // TypeError: failed to fetch // (*)
```

### Callback to async & await ì •ë‹µ ì½”ë“œ
<details markdown="1">  
<summary>í•´ë‹µ</summary>   

```js
'use strict';
// Callback Hell example
class UserStorage {
    loginUser(id, password) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (
                    (id === 'raccoon' && password === '123') ||
                    (id === 'cat' && password === '456')
                ) {
                    resolve(id);
                } else {
                    reject(new Error('not found'));
                }
            })
        }, 2000);
    }

    getRoles(user) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (user === 'raccoon') {
                    resolve({ name: 'raccoon', role: 'admin'});
                } else {
                    reject(new Error('no access'));
                }
            }, 2000);
        })
    }

    async getUserData(id, password) {
        try{
            const userId = await this.loginUser(id, password);
            const user = await this.getRoles(userId);
            alert(`hello, ${user.name}. you have ${user.role} role`);
        }catch (error) {
            console.log(error);
        }
    }
}


const userStorage = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
userStorage
    .getUserData(id, password);
```

</details> 

### ì°¸ê³  ìë£Œ(Reference)
[ë“œë¦¼ì½”ë”© ìœ íŠœë¸Œ](https://www.youtube.com/watch?v=aoQSOZfz3vQ&list=PLv2d7VI9OotTVOL4QmPfvJWPJvkmv6h-2&index=13)   
[ëª¨ë˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ìš”ì•½](https://ko.javascript.info/async-await)
